<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="mapper.prodOrder">
	<select id="prodOrderList" parameterType="Long" resultType="prodOrderVo">
		select
			poi.pdOrderNum, poi.amount, poi.price,
			p.productNum, p.sellerNum, p.productName,
			s.sellerNum, s.storeName,
			po.userNum, po.pdTotalPrice, po.orderDate, po.deleveryStatus, po.orderStatus
		from productOrderItem poi
		Join product p on poi.productNum = p.productNum
		Join sellerdetail s on p.sellerNum = s.sellerNum
		join productOrder po on poi.pdOrderNum = po.pdOrderNum
		where po.userNum = #{userNum}
		order by po.orderDate desc
	</select>
	
	<select id="prodDetailOrderList" parameterType="Long" resultType="prodOrderVo">
		select
			poi.pdOrderNum, poi.amount, poi.price,
			p.productNum, p.sellerNum, p.productName,
			s.sellerNum, s.storeName,
			po.userNum, po.pdTotalPrice, po.orderDate, po.deleveryStatus, po.orderStatus
		from productOrderItem poi
		Join product p on poi.productNum = p.productNum
		Join sellerdetail s on p.sellerNum = s.sellerNum
		join productOrder po on poi.pdOrderNum = po.pdOrderNum
		where poi.pdOrderNum = #{pdOrderNum}
	</select>
	
	<update id="updatePdDeliveryStatus" parameterType="prodOrder">
		update productOrder
		set deleveryStatus = #{deleveryStatus}
		where pdOrderNum = #{pdOrderNum}
	</update>
	
	<select id="selectSellerProdOrderList" parameterType="map" resultType="prodOrderVo">
		select
			po.pdOrderNum, po.userNum, po.orderDate,po.address, po.orderStatus, po.deleveryStatus, po.trackingNum 
			poi.productNum, poi.optionNum, poi.amount, poi.price * poi.amount as totalProductPrice,
			u.userId, u.userName,u.phone,
			opt.option
		from productOrder po
		join productOrderItem poi on po.pdOrderNum = poi.pdOrderNum
		join productOption opt on poi.optionNum = opt.optionNum
		join user u on po.userNum = u.userNum
		where po.sellerNum = #{sellerNum}
		<if test="dateType != null and dateType != ''">
		  <if test="dateType == 'paymentDate'">
		    AND DATE(po.orderDate) BETWEEN #{startDate} AND #{endDate}
		  </if>
		  <if test="dateType == 'orderDate'">
		    AND DATE(po.orderedAt) BETWEEN #{startDate} AND #{endDate}
		  </if>
		</if>
		<if test="searchType != null and searchType != '' and searchType != 'all' and searchKeyword != null and searchKeyword != ''">
		  <choose>
		    <when test="searchType == 'userName'">
		      AND u.userName LIKE CONCAT('%', #{searchKeyword}, '%')
		    </when>
		    <when test="searchType == 'pdOrderNum'">
		      AND po.pdOrderNum = #{searchKeyword}
		    </when>
		    <when test="searchType == 'productNum'">
		      AND poi.productNum = #{searchKeyword}
		    </when>
		    <when test="searchType == 'trackingNum'">
		      AND po.trackingNum = #{searchKeyword}
		    </when>
		  </choose>
		</if>
		ORDER BY po.orderDate DESC
		LIMIT #{offset}, #{pageSize}
				
	</select>
	
	<select id="sellectCountSellerProdOrderList" parameterType="map" resultType="Integer">
		  SELECT COUNT(*)
		    FROM productOrder po
		    JOIN user u ON po.userNum = u.userNum
		    <where>
		        po.sellerNum = #{sellerNum}
		        
		        <if test="dateType != null and startDate != null and endDate != null">
		            AND 
		            <choose>
		                <when test="dateType == 'paymentDate'">
		                    DATE(po.orderDate) BETWEEN #{startDate} AND #{endDate}
		                </when>
		                <when test="dateType == 'orderDate'">
		                    DATE(po.orderedAt) BETWEEN #{startDate} AND #{endDate}
		                </when>
		            </choose>
		        </if>
		        
		        <if test="searchType != null and searchType != '' and searchKeyword != null and searchKeyword != ''">
		            <choose>
		                <when test="searchType == 'userName'">
		                    AND u.userName LIKE CONCAT('%', #{searchKeyword}, '%')
		                </when>
		                <when test="searchType == 'pdOrderNum'">
		                    AND po.pdOrderNum = #{searchKeyword}
		                </when>
		                <when test="searchType == 'productNum'">
		                    AND EXISTS (
		                        SELECT 1 
		                        FROM productOrderItem poi 
		                        WHERE poi.pdOrderNum = po.pdOrderNum 
		                        AND poi.productNum = #{searchKeyword}
		                    )
		                </when>
		                <when test="searchType == 'trackingNum'">
		                    AND po.trackingNum = #{searchKeyword}
		                </when>
		            </choose>
		        </if>
		    </where>	
	</select>
	<insert id="insertProductOrder" parameterType="map" useGeneratedKeys="true" keyProperty="pdOrderNum">
	    INSERT INTO productorder (userNum, pdTotalPrice, address, deleveryStatus, orderStatus)
	    VALUES (#{userNum}, #{pdTotalPrice}, #{address}, #{deleveryStatus}, #{orderStatus})
	</insert>
	<insert id="insertProductOrderItem" parameterType="map">
        INSERT INTO productorderitem (pdOrderNum, productNum, optionNum, amount, price)
        VALUES (#{pdOrderNum}, #{productNum}, #{optionNum}, #{amount}, #{price})
    </insert>

</mapper>