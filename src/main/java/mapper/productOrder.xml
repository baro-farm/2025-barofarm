<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="mapper.prodOrder">
	<select id="prodOrderList" parameterType="Long" resultType="prodOrderVo">
		select
			poi.pdOrderNum, poi.amount, poi.price,
			p.productNum, p.sellerNum, p.productName,
			s.sellerNum, s.storeName,
			po.userNum, po.pdTotalPrice, po.orderDate, po.deleveryStatus, po.orderStatus
		from productOrderItem poi
		Join product p on poi.productNum = p.productNum
		Join sellerdetail s on p.sellerNum = s.sellerNum
		join productOrder po on poi.pdOrderNum = po.pdOrderNum
		where po.userNum = #{userNum}
		order by po.orderDate desc
	</select>
	
	<!-- Count 쿼리 -->
	<select id="selectUserProdOrderCount" parameterType="map" resultType="Integer">
	  SELECT COUNT(*)
	  FROM productOrder po
	  JOIN productOrderItem poi ON po.pdOrderNum = poi.pdOrderNum
	  JOIN product p ON poi.productNum = p.productNum
	  WHERE po.userNum = #{userNum}
	    <if test="startDate != null and startDate != ''">
	      AND po.orderDate &gt;= #{startDate}
	    </if>
	    <if test="endDate != null and endDate != ''">
	      AND po.orderDate &lt;= #{endDate}
	    </if>
	    <if test="deliveryStatus != null and deliveryStatus != ''">
	      AND po.deleveryStatus = #{deliveryStatus}
	    </if>
	</select>	
	
	<!-- 리스트 쿼리 -->
	<select id="selectUserProdOrderList" parameterType="map" resultType="prodOrderVo">
	  SELECT poi.pdOrderNum, poi.amount, poi.price,
	         p.productNum, p.sellerNum, p.productName, p.imgUrl,
	         po.userNum, po.pdTotalPrice, po.orderDate, po.deleveryStatus
	  FROM `productOrder` po
	  JOIN productOrderItem poi ON po.pdOrderNum = poi.pdOrderNum
	  JOIN product p ON poi.productNum = p.productNum
	  WHERE po.userNum = #{userNum}
	    <if test="startDate != null and startDate != ''">
	      AND po.orderDate &gt;= #{startDate}
	    </if>
	    <if test="endDate != null and endDate != ''">
	      AND po.orderDate &lt;= #{endDate}
	    </if>
	    <if test="deliveryStatus != null and deliveryStatus != ''">
	      AND po.deleveryStatus = #{deliveryStatus}
	    </if>
	  ORDER BY po.orderDate DESC
	  LIMIT #{offset}, #{limit}
	</select>
	
	<select id="prodDetailOrderList" parameterType="Long" resultType="prodOrderVo">
		select
			poi.pdOrderNum, poi.amount, poi.price,
			p.productNum, p.sellerNum, p.productName,p.imgUrl,po.rname,po.rphone, po.address,
			s.sellerNum, s.storeName,
			po.userNum, po.pdTotalPrice, po.orderDate, po.deleveryStatus, po.orderStatus
		from productOrderItem poi
		Join product p on poi.productNum = p.productNum
		Join sellerdetail s on p.sellerNum = s.sellerNum
		join productOrder po on poi.pdOrderNum = po.pdOrderNum
		where poi.pdOrderNum = #{pdOrderNum}
	</select>
	
	<update id="updatePdDeliveryStatus" parameterType="prodOrder">
		update productOrder
		set deleveryStatus = #{deleveryStatus}
		where pdOrderNum = #{pdOrderNum}
	</update>
	
	<update id="updatePdTrackingNum" parameterType="map">
		update productOrder
		set trackingNum =#{trackingNum}
		where pdOrderNum = #{pdOrderNum}
	</update>
	
	<select id="selectSellerProdOrderList" parameterType="map" resultType="prodOrderVo">
		SELECT 
		    po.pdOrderNum,              
		    poi.orderItem,              
		    poi.productNum,            
		    pOpt.option,  
		    pOpt.price AS optionPrice,  
		    poi.amount,                 
		    (pOpt.price * poi.amount) AS totalPrice,
		    po.orderDate,             
		    CONCAT(
			    LEFT(u.userId, 1),        
			    REPEAT('*', CHAR_LENGTH(u.userId) - 2),
			    RIGHT(u.userId, 1)
			) as userId,
		    u.userName, 
		    po.address,
		    u.phone,
		    po.orderStatus, 
		    po.deleveryStatus,
		    po.trackingNum
		FROM 
		    productorder po
		JOIN 
		    productorderitem poi ON po.pdOrderNum = poi.pdOrderNum
		JOIN 
		    productoption pOpt ON poi.optionNum = pOpt.optionNum
		JOIN 
		    product p ON poi.productNum = p.productNum
		JOIN 
		    user u ON po.userNum = u.userNum
		WHERE 
		    p.sellerNum = #{sellerNum}
		<if test="startDate != null and endDate != null">
		  <if test="dateType == 'paymentDate'">
		    AND DATE(po.orderDate) BETWEEN #{startDate} AND #{endDate}
		  </if>
		  <if test="dateType == 'orderDate'">
		    AND DATE(po.orderedAt) BETWEEN #{startDate} AND #{endDate}
		  </if>
		</if>
		<if test="searchType != null and searchType != '' and searchType != 'all' and searchKeyword != null and searchKeyword != ''">
		  <choose>
		    <when test="searchType == 'userName'">
		      AND u.userName LIKE CONCAT('%', #{searchKeyword}, '%')
		    </when>
		    <when test="searchType == 'pdOrderNum'">
		      AND po.pdOrderNum = #{searchKeyword}
		    </when>
		    <when test="searchType == 'productNum'">
		      AND poi.productNum = #{searchKeyword}
		    </when>
		    <when test="searchType == 'trackingNum'">
		      AND po.trackingNum = #{searchKeyword}
		    </when>
		  </choose>
		</if>
		ORDER BY po.orderDate DESC
		LIMIT #{offset}, #{pageSize}
				
	</select>
	
	<select id="sellectCountSellerProdOrderList" parameterType="map" resultType="Integer">
	    SELECT 
	        COUNT(DISTINCT po.pdOrderNum)
	    FROM 
	        productorder po
	    JOIN 
	        productorderitem poi ON po.pdOrderNum = poi.pdOrderNum
	    JOIN 
	    	productoption pOpt ON poi.optionNum = pOpt.optionNum
	    JOIN 
	        product p ON poi.productNum = p.productNum
	        
	    JOIN 
	        user u ON po.userNum = u.userNum
	    WHERE 
	        p.sellerNum = #{sellerNum}
		<choose>
		  <when test="startDate != null and endDate != null">
		    <choose>
		      <when test="dateType == 'paymentDate'">
		        AND DATE(po.orderDate) BETWEEN #{startDate} AND #{endDate}
		      </when>
		      <when test="dateType == 'orderDate'">
		        AND DATE(po.orderedAt) BETWEEN #{startDate} AND #{endDate}
		      </when>
		    </choose>
		  </when>
		  <otherwise>
		    <!-- 날짜 조건 없음 -->
		  </otherwise>
		</choose>
	    <if test="searchType != null and searchType != '' and searchType != 'all' and searchKeyword != null and searchKeyword != ''">
	        <choose>
	            <when test="searchType == 'userName'">
	                AND u.userName LIKE CONCAT('%', #{searchKeyword}, '%')
	            </when>
	            <when test="searchType == 'pdOrderNum'">
	                AND po.pdOrderNum = #{searchKeyword}
	            </when>
	            <when test="searchType == 'productNum'">
	                AND poi.productNum = #{searchKeyword}
	            </when>
	            <when test="searchType == 'trackingNum'">
	                AND po.trackingNum = #{searchKeyword}
	            </when>
	        </choose>
	    </if>	
	</select>
	<insert id="insertProductOrder" parameterType="map" useGeneratedKeys="true" keyProperty="pdOrderNum">
	    INSERT INTO productorder (userNum, pdTotalPrice, address, deleveryStatus, orderStatus, rName, rPhone)
	    VALUES (#{userNum}, #{pdTotalPrice}, #{address}, #{deleveryStatus}, #{orderStatus}, #{rName}, #{rPhone})
	</insert>
	<insert id="insertProductOrderItem" parameterType="prodOrderItem">
        INSERT INTO productorderitem (pdOrderNum, productNum, optionNum, amount, price)
        VALUES (#{pdOrderNum}, #{productNum}, #{optionNum}, #{amount}, #{price})
    </insert>

</mapper>